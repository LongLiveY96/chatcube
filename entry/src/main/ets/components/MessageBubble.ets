import { ChatMessage, MessageRole, MessageAttachment, AttachmentType, ToolCall, ToolResult } from '../models/ChatModels'
import { Markdown, MarkdownController } from '@luvi/lv-markdown-in'
import { pasteboard } from '@kit.BasicServicesKit'
import { showToast } from '../utils/ToastUtil'
import { getModelIconPath, buildIconResourcePath } from '../utils/ProviderIconUtils'
import { SearchReferenceCard } from './SearchReferenceCard'
import { ToolCallCard } from './ToolCallCard'
import { HtmlPreviewCard } from './HtmlPreviewCard'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { webview } from '@kit.ArkWeb'
import { SymbolGlyphModifier } from '@kit.ArkUI'

const DOMAIN = 0x0002
const TAG = 'MessageBubble'

// ç¿»è¯‘ç›®æ ‡è¯­è¨€é…ç½®
interface TranslateLanguage {
  code: string
  name: string
  nativeName: string
}

// å†…å®¹åˆ†æ®µï¼ˆç”¨äº HTML ä»£ç å—å†…è”é¢„è§ˆï¼‰
interface ContentSegment {
  isHtml: boolean
  content: string
}

@Component
export struct MessageBubble {
  @ObjectLink @Watch('onMessageStateChange') message: ChatMessage
  @Prop showHeader: boolean = true  // æ˜¯å¦æ˜¾ç¤ºæ¶ˆæ¯å¤´éƒ¨ï¼ˆæ¨¡å‹ä¿¡æ¯ï¼‰
  @Prop currentModelId: string = ''  // å½“å‰ä¼šè¯çš„æ¨¡å‹ IDï¼ˆç”¨äºå›¾æ ‡åŒ¹é…å›é€€ï¼‰
  @Prop isMultiSelectMode: boolean = false  // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
  @Prop isSelected: boolean = false  // æ˜¯å¦è¢«é€‰ä¸­
  @Prop isEditing: boolean = false  // æ˜¯å¦å¤„äºç¼–è¾‘çŠ¶æ€ï¼ˆè¢«ç¼–è¾‘çš„æ¶ˆæ¯é«˜äº®æ˜¾ç¤ºï¼‰
  @Prop previewContent: string = ''  // ç¼–è¾‘æ—¶çš„å®æ—¶é¢„è§ˆå†…å®¹
  @Prop previewAttachments: MessageAttachment[] = []  // ç¼–è¾‘æ—¶çš„å®æ—¶é¢„è§ˆé™„ä»¶
  @State isReasoningExpanded: boolean = false  // æ¨ç†å†…å®¹æ˜¯å¦å±•å¼€
  @State translatedText: string = ''  // ç¿»è¯‘ç»“æœ
  @State isTranslating: boolean = false  // æ˜¯å¦æ­£åœ¨ç¿»è¯‘
  @State showTranslation: boolean = false  // æ˜¯å¦æ˜¾ç¤ºç¿»è¯‘ç»“æœ
  @State isTranslationExpanded: boolean = true  // ç¿»è¯‘ç»“æœæ˜¯å¦å±•å¼€
  @State currentTranslateLang: string = ''  // å½“å‰ç¿»è¯‘çš„ç›®æ ‡è¯­è¨€
  // æ·±è‰²æ¨¡å¼çŠ¶æ€ï¼ˆç”¨äºä¸»é¢˜é€‚é…ï¼‰ï¼Œä½¿ç”¨ @Watch ç›‘å¬å˜åŒ–
  @StorageProp('isDarkMode') @Watch('onDarkModeChange') isDarkMode: boolean = false
  // ä¸»é¢˜é¢œè‰²ï¼ˆä» ThemeService åŒæ­¥ï¼‰
  @StorageProp('theme_user_bubble') @Watch('onThemeColorChange') themeUserBubble: string = '#0A59F7'
  @StorageProp('theme_user_bubble_text') themeUserBubbleText: string = '#FFFFFF'
  @StorageProp('theme_ai_bubble') @Watch('onThemeColorChange') themeAiBubble: string = '#FFFFFF'
  @StorageProp('theme_primary') @Watch('onThemeColorChange') themePrimary: string = '#0A59F7'

  // Markdown é“¾æ¥ï¼šç»Ÿä¸€ç”¨åŠæ¨¡æ€ Web Sheet æ‰“å¼€
  @State showWebSheet: boolean = false
  @State webSheetUrl: string = ''
  @State webSheetTitle: string = ''
  private sheetWebController: webview.WebviewController = new webview.WebviewController()

  // ========== Markdown é…ç½® ==========
  // MarkdownController å®ä¾‹
  private markdownController: MarkdownController = new MarkdownController()
  private reasoningMarkdownController: MarkdownController = new MarkdownController()
  private translationMarkdownController: MarkdownController = new MarkdownController()

  // ========== æµå¼æ¸²æŸ“ä¼˜åŒ– ==========
  // lv-markdown-in è‡ªå¸¦æµå¼æ¸²æŸ“ï¼Œæ— éœ€æ‰‹åŠ¨èŠ‚æµ
  // è·³åŠ¨ç‚¹åŠ¨ç”»çŠ¶æ€
  @State dot1Scale: number = 0.6
  @State dot2Scale: number = 0.6
  @State dot3Scale: number = 0.6
  private dotAnimationTimer: number = -1
  @StorageProp('speakingMessageId') speakingMessageId: string = ''  // å½“å‰æ­£åœ¨æœ—è¯»çš„æ¶ˆæ¯ID
  // èŠå¤©å›¾ç‰‡ç´§å‡‘å±•ç¤ºå‚æ•°
  private compactImageMaxHeight: number = 120
  private compactImageContainerWidth: number = 180
  private compactImageGap: number = 6

  onRegenerate: () => void = () => {}
  onCopy: () => void = () => {}
  onDelete: () => void = () => {}
  onEdit: () => void = () => {}
  onCancelEdit: () => void = () => {}  // å–æ¶ˆç¼–è¾‘å›è°ƒ
  onShareMessage: () => void = () => {}
  onTranslate: (content: string, targetLang: string, callback: (result: string, errorMessage: string) => void) => void = () => {}
  // å›¾ç‰‡ç‚¹å‡»é¢„è§ˆå›è°ƒ
  onImageClick: (images: Array<string>, index: number) => void = () => {}
  // TTSæœ—è¯»å›è°ƒ
  onTTS: (messageId: string, content: string) => void = () => {}
  onTTSStop: () => void = () => {}
  // å¤šé€‰æ¨¡å¼å›è°ƒ
  onSelect: (messageId: string) => void = () => {}
  onEnterMultiSelect: (messageId: string) => void = () => {}

  // æ”¯æŒçš„ç¿»è¯‘è¯­è¨€åˆ—è¡¨
  private translateLanguages: TranslateLanguage[] = [
    { code: 'zh-CN', name: 'Chinese', nativeName: 'ç®€ä½“ä¸­æ–‡' },
    { code: 'en', name: 'English', nativeName: 'English' },
    { code: 'zh-TW', name: 'Traditional Chinese', nativeName: 'ç¹é«”ä¸­æ–‡' },
    { code: 'ja', name: 'Japanese', nativeName: 'æ—¥æœ¬èª' },
    { code: 'ko', name: 'Korean', nativeName: 'í•œêµ­ì–´' },
    { code: 'fr', name: 'French', nativeName: 'FranÃ§ais' },
    { code: 'de', name: 'German', nativeName: 'Deutsch' },
    { code: 'it', name: 'Italian', nativeName: 'Italiano' },
    { code: 'es', name: 'Spanish', nativeName: 'EspaÃ±ol' }
  ]

  // è·å–å½“å‰æ¶ˆæ¯æ¨¡å‹å›¾æ ‡æ–‡ä»¶åï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ— å¯ç”¨å›¾æ ‡ï¼‰
  private getCurrentMessageModelIconPath(): string {
    // ä¼˜å…ˆç”¨ modelId â†’ å›é€€åˆ°å½“å‰ä¼šè¯æ¨¡å‹ ID â†’ æœ€åå›é€€åˆ° modelName
    let id = this.message.modelId
    if (id === '' || id === undefined) {
      id = this.currentModelId
    }
    if (id === '' || id === undefined) {
      id = this.message.modelName
    }
    if (id === '' || id === undefined) {
      return ''
    }
    return getModelIconPath(id, '', '')
  }

  // è·å–å½“å‰æ¶ˆæ¯æ¨¡å‹å›¾æ ‡èµ„æºè·¯å¾„ï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ— å¯ç”¨å›¾æ ‡ï¼‰
  private getCurrentMessageModelIconResourcePath(): string {
    const iconPath = this.getCurrentMessageModelIconPath()
    if (iconPath === '') {
      return ''
    }
    return buildIconResourcePath(iconPath)
  }

  aboutToAppear(): void {
    hilog.info(DOMAIN, TAG, 'ğŸ“ MessageBubble åˆå§‹åŒ– (æ¶ˆæ¯ID: %{public}s, è§’è‰²: %{public}s)',
      this.message.id, this.message.role === MessageRole.USER ? 'USER' : 'ASSISTANT')

    // ç¿»è¯‘å†…å®¹åŠ¨æ€å˜åŒ–ï¼Œä½¿ç”¨æ–°çš„ Controller
    this.translationMarkdownController = new MarkdownController()

    // é…ç½® Markdown æ ·å¼
    this.configureMarkdownStyles()

    // åªåœ¨éœ€è¦æ—¶å¯åŠ¨è·³åŠ¨ç‚¹åŠ¨ç”»ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
    if (this.shouldShowDotAnimation()) {
      this.startDotAnimation()
    }

    // æ¨ç†å†…å®¹é»˜è®¤å±•å¼€é€»è¾‘ï¼šè¾ƒçŸ­æ—¶ï¼ˆ<500å­—ç¬¦ï¼‰é»˜è®¤å±•å¼€ï¼Œè¾ƒé•¿æ—¶é»˜è®¤æŠ˜å 
    if (this.message.reasoningContent.length > 0 && this.message.reasoningContent.length < 500) {
      this.isReasoningExpanded = true
    }
  }

  // æ¶ˆæ¯çŠ¶æ€å˜åŒ–å›è°ƒï¼ˆä¼˜åŒ–è·³åŠ¨ç‚¹åŠ¨ç”»æ€§èƒ½ï¼‰
  private onMessageStateChange(): void {
    if (this.shouldShowDotAnimation()) {
      this.startDotAnimation()
    } else {
      this.stopDotAnimation()
    }
  }

  // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ˜¾ç¤ºè·³åŠ¨ç‚¹åŠ¨ç”»
  private shouldShowDotAnimation(): boolean {
    // æ­£åœ¨ç”Ÿæˆä¸”æ— å†…å®¹æ—¶éœ€è¦æ˜¾ç¤ºè·³åŠ¨ç‚¹åŠ¨ç”»
    const isGeneratingWithoutContent = this.message.isGenerating &&
      this.message.content.length === 0 &&
      this.message.reasoningContent.length === 0
    // æ­£åœ¨æœç´¢æ—¶ä¹Ÿéœ€è¦æ˜¾ç¤ºè·³åŠ¨ç‚¹åŠ¨ç”»ï¼ˆè”ç½‘æŸ¥è¯¢ç­‰å¾…çŠ¶æ€ï¼‰
    return isGeneratingWithoutContent || this.message.isSearching
  }

  // é…ç½® Markdown æ ·å¼
  private configureMarkdownStyles(): void {
    // æ‰€æœ‰é¢œè‰²ä½¿ç”¨èµ„æºå¼•ç”¨ï¼Œè‡ªåŠ¨è·Ÿéšç³»ç»Ÿæ·±æµ…è‰²
    const titleColor = $r('app.color.markdown_title')
    const textColor = $r('app.color.markdown_text')
    const reasoningTextColor = $r('app.color.text_secondary')
    const quoteBgColor = $r('app.color.markdown_quote_bg')
    const linkColor = $r('app.color.markdown_link')
    const linkBgColor = $r('app.color.markdown_link_bg')
    const inlineCodeBgColor = $r('app.color.markdown_code_bg')
    const inlineCodeTextColor = $r('app.color.markdown_code_text')
    const tableBgColor = $r('app.color.markdown_table_bg')
    const tableHeaderBgColor = $r('app.color.markdown_table_header_bg')
    const tableAltBgColor = $r('app.color.markdown_table_alt_bg')
    const tableBorderColor = $r('app.color.markdown_table_border')
    const codeTheme = this.isDarkMode ? 'dark' : 'light'

    // æ•°å­¦å…¬å¼é¢œè‰²æ¥å£éœ€è¦ numberï¼ˆARGBï¼‰ï¼Œä¸èƒ½ç›´æ¥ä¼  ResourceColor
    const latexTextColor = this.isDarkMode ? 0xFFE0E0E0 : 0xFF333333
    const latexTextColorSecondary = 0xFF999999

    // é…ç½®ä¸»å†…å®¹ Markdown
    this.markdownController
      .setTitleColor(titleColor)
      .setTextColor(textColor)
      .setTextSize(14)
      .setTextLineHeight(22)
      .setTitleSize([22, 20, 18, 16, 15, 14])
      .setQuoteBackgroundColor(quoteBgColor)
      .setQuoteBorderColor(linkColor)
      .setHyperlinkTextColor(linkColor)
      .setHyperlinkBackgroundColor(linkBgColor)
      .setInlineCodeColor(inlineCodeTextColor)
      .setInlineCodeBackgroundColor(inlineCodeBgColor)
      .setCodeBlockTheme(codeTheme)
      .setLatexMathTextColor(latexTextColor)
      .setTableBackgroundColor(tableBgColor)
      .setTableTitleBackgroundColor(tableHeaderBgColor)
      .setTableInterleaveBackgroundColor(tableAltBgColor)
      .setTableOuterBorderColor(tableBorderColor)
      .setTableInnerBorderColor(tableBorderColor)
      .setUlPointColor(textColor)
      .setLineColor(tableBorderColor)
      .setFootnoteTextColor(linkColor)
      .setHyperlinkClickListener((title: string, src: string): boolean => {
        return this.openWebSheetForLink(title, src)
      })
      .setCodeCopyListener((code: string) => {
        this.copyToClipboard(code)
      })

    // é…ç½®æ¨ç†å†…å®¹ Markdownï¼ˆæ›´ç´§å‡‘ï¼‰
    this.reasoningMarkdownController
      .setTitleColor(reasoningTextColor)
      .setTextColor(reasoningTextColor)
      .setTextSize(13)
      .setTextLineHeight(20)
      .setTitleSize([18, 16, 15, 14, 13, 13])
      .setQuoteBackgroundColor(quoteBgColor)
      .setQuoteBorderColor(linkColor)
      .setHyperlinkTextColor(linkColor)
      .setHyperlinkBackgroundColor(linkBgColor)
      .setInlineCodeColor(inlineCodeTextColor)
      .setInlineCodeBackgroundColor(inlineCodeBgColor)
      .setCodeBlockTheme(codeTheme)
      .setLatexMathTextColor(latexTextColorSecondary)
      .setTableBackgroundColor(tableBgColor)
      .setTableTitleBackgroundColor(tableHeaderBgColor)
      .setTableInterleaveBackgroundColor(tableAltBgColor)
      .setTableOuterBorderColor(tableBorderColor)
      .setTableInnerBorderColor(tableBorderColor)
      .setUlPointColor(reasoningTextColor)
      .setLineColor(tableBorderColor)
      .setFootnoteTextColor(linkColor)
      .setHyperlinkClickListener((title: string, src: string): boolean => {
        return this.openWebSheetForLink(title, src)
      })
      .setCodeCopyListener((code: string) => {
        this.copyToClipboard(code)
      })

    // é…ç½®ç¿»è¯‘å†…å®¹ Markdown
    this.translationMarkdownController
      .setTitleColor(titleColor)
      .setTextColor(textColor)
      .setTextSize(13)
      .setTextLineHeight(20)
      .setTitleSize([20, 18, 16, 15, 14, 13])
      .setQuoteBackgroundColor(quoteBgColor)
      .setQuoteBorderColor(linkColor)
      .setHyperlinkTextColor(linkColor)
      .setHyperlinkBackgroundColor(linkBgColor)
      .setInlineCodeColor(inlineCodeTextColor)
      .setInlineCodeBackgroundColor(inlineCodeBgColor)
      .setCodeBlockTheme(codeTheme)
      .setLatexMathTextColor(latexTextColor)
      .setTableBackgroundColor(tableBgColor)
      .setTableTitleBackgroundColor(tableHeaderBgColor)
      .setTableInterleaveBackgroundColor(tableAltBgColor)
      .setTableOuterBorderColor(tableBorderColor)
      .setTableInnerBorderColor(tableBorderColor)
      .setUlPointColor(textColor)
      .setLineColor(tableBorderColor)
      .setFootnoteTextColor(linkColor)
      .setHyperlinkClickListener((title: string, src: string): boolean => {
        return this.openWebSheetForLink(title, src)
      })
      .setCodeCopyListener((code: string) => {
        this.copyToClipboard(code)
      })
  }

  // æ·±è‰²æ¨¡å¼å˜åŒ–ç›‘å¬
  onDarkModeChange(): void {
    hilog.info(DOMAIN, TAG, 'ğŸ¨ æ·±è‰²æ¨¡å¼å˜åŒ–: %{public}s (æ¶ˆæ¯ID: %{public}s)',
      this.isDarkMode ? 'æ·±è‰²' : 'æµ…è‰²', this.message.id)

    // é‡æ–°é…ç½® Markdown æ ·å¼
    this.configureMarkdownStyles()

    hilog.info(DOMAIN, TAG, 'âœ… Markdown æ ·å¼å·²æ›´æ–°')
  }

  // ä¸»é¢˜é¢œè‰²å˜åŒ–ç›‘å¬
  onThemeColorChange(): void {
    hilog.info(DOMAIN, TAG, 'ğŸ¨ ä¸»é¢˜é¢œè‰²å˜åŒ– (æ¶ˆæ¯ID: %{public}s)', this.message.id)
    // ä¸»é¢˜é¢œè‰²å˜åŒ–æ—¶é‡æ–°é…ç½® Markdown æ ·å¼
    this.configureMarkdownStyles()
  }

  // è®¡ç®—æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæ¨ç†å†…å®¹ï¼ˆç”Ÿæˆä¸­è‡ªåŠ¨å±•å¼€ï¼‰
  private get shouldShowReasoning(): boolean {
    return this.isReasoningExpanded || (this.message.isGenerating && this.message.reasoningContent.length > 0)
  }

  aboutToDisappear(): void {
    // æ¸…ç†åŠ¨ç”»å®šæ—¶å™¨
    this.stopDotAnimation()
  }

  // å¯åŠ¨è·³åŠ¨ç‚¹åŠ¨ç”»
  private startDotAnimation(): void {
    if (this.dotAnimationTimer !== -1) {
      return
    }
    let step = 0
    this.dotAnimationTimer = setInterval(() => {
      const currentDot = step % 3
      this.getUIContext().animateTo({
        duration: 300,
        curve: Curve.EaseInOut
      }, () => {
        // é‡ç½®æ‰€æœ‰ç‚¹
        this.dot1Scale = 0.6
        this.dot2Scale = 0.6
        this.dot3Scale = 0.6
        // å½“å‰ç‚¹æ”¾å¤§
        if (currentDot === 0) {
          this.dot1Scale = 1.0
        } else if (currentDot === 1) {
          this.dot2Scale = 1.0
        } else {
          this.dot3Scale = 1.0
        }
      })
      step++
    }, 300)
  }

  // åœæ­¢è·³åŠ¨ç‚¹åŠ¨ç”»
  private stopDotAnimation(): void {
    if (this.dotAnimationTimer !== -1) {
      clearInterval(this.dotAnimationTimer)
      this.dotAnimationTimer = -1
    }
  }

  build() {
    Column() {
      // ç¼–è¾‘çŠ¶æ€æ ‡ç­¾ï¼ˆç‚¹å‡»å¯å–æ¶ˆç¼–è¾‘ï¼‰
      if (this.isEditing) {
        Row() {
          SymbolGlyph($r('sys.symbol.square_and_pencil'))
            .fontSize(10)
            .fontColor([this.themePrimary])

          Text($r('app.string.editing_message'))
            .fontSize(10)
            .fontColor(this.themePrimary)
            .margin({ left: 4 })
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor($r('app.color.chat_ai_bubble'))
        .borderRadius(10)
        .margin({ bottom: 4 })
        .alignSelf(ItemAlign.End)
        .onClick(() => {
          this.onCancelEdit()
        })
      }

      if (this.message.role === MessageRole.USER) {
        this.UserMessage()
      } else {
        this.AssistantMessage()
      }
    }
    .width('100%')
    // ç¼–è¾‘æ¨¡å¼é«˜äº®æ•ˆæœ
    .scale(this.isEditing ? { x: 1.02, y: 1.02 } : { x: 1, y: 1 })
    .animation({ duration: 200 })
    // æ–°æ¶ˆæ¯å…¥åœºåŠ¨ç”»ï¼šç”¨æˆ·æ¶ˆæ¯ä»å³ä¾§æ»‘å…¥ï¼ŒAIæ¶ˆæ¯ä»å·¦ä¾§æ»‘å…¥
    .transition(
      TransitionEffect.asymmetric(
        // å…¥åœºï¼šæ»‘å…¥ + æ·¡å…¥
        TransitionEffect.translate({
          x: this.message.role === MessageRole.USER ? 30 : -30
        }).combine(TransitionEffect.OPACITY),
        // é€€åœºï¼šä»…æ·¡å‡º
        TransitionEffect.OPACITY
      ).animation({ duration: 250, curve: Curve.EaseOut })
    )
    .bindSheet($$this.showWebSheet, this.WebSheetBuilder(), {
      height: SheetSize.LARGE,
      detents: [SheetSize.LARGE],
      dragBar: true,
      showClose: true,
      title: { title: this.webSheetTitle !== '' ? this.webSheetTitle : $r('app.string.common_web_page') },
      onDisappear: () => {
        this.webSheetUrl = ''
        this.webSheetTitle = ''
      }
    })
  }

  // å¤„ç†ç¿»è¯‘
  private handleTranslate(targetLang: string): void {
    if (this.isTranslating) {
      return
    }
    this.isTranslating = true
    this.showTranslation = true
    this.isTranslationExpanded = true
    this.translatedText = ''
    this.currentTranslateLang = targetLang

    this.onTranslate(this.message.content, targetLang, (result: string, errorMessage: string) => {
      this.translatedText = result
      this.isTranslating = false
      if (result === '' && errorMessage !== '') {
        showToast(this.getUIContext(), errorMessage, 3000)
      }
    })
  }

  // è·å–æ˜¾ç¤ºå†…å®¹ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ä½¿ç”¨é¢„è§ˆå†…å®¹ï¼‰
  private getDisplayContent(): string {
    if (this.isEditing) {
      return this.previewContent
    }
    return this.message.content
  }

  // æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«å®Œæ•´çš„ HTML ä»£ç å—
  private hasHtmlBlocks(content: string): boolean {
    return /```html?\s*\n[\s\S]*?```/.test(content)
  }

  // å°†å†…å®¹æŒ‰ HTML ä»£ç å—è¾¹ç•Œåˆ†æ®µï¼Œç”¨äºå†…è”é¢„è§ˆæ¸²æŸ“
  private splitContentToSegments(content: string): ContentSegment[] {
    const segments: ContentSegment[] = []
    const pattern = /```html?\s*\n([\s\S]*?)```/g
    let lastIndex = 0
    let match = pattern.exec(content)

    while (match !== null) {
      const matchIndex = match.index
      // æ·»åŠ  HTML ä»£ç å—ä¹‹å‰çš„æ–‡æœ¬æ®µ
      if (matchIndex > lastIndex) {
        const textContent = content.substring(lastIndex, matchIndex)
        if (textContent.trim().length > 0) {
          segments.push({ isHtml: false, content: textContent } as ContentSegment)
        }
      }
      // æ·»åŠ  HTML ä»£ç å—æ®µ
      segments.push({ isHtml: true, content: match[1] } as ContentSegment)
      lastIndex = matchIndex + match[0].length
      match = pattern.exec(content)
    }

    // æ·»åŠ æœ€åä¸€ä¸ª HTML ä»£ç å—ä¹‹åçš„å‰©ä½™æ–‡æœ¬
    if (lastIndex < content.length) {
      const remaining = content.substring(lastIndex)
      if (remaining.trim().length > 0) {
        segments.push({ isHtml: false, content: remaining } as ContentSegment)
      }
    }

    return segments
  }

  // æ˜¯å¦æœ‰æ˜¾ç¤ºé™„ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ä½¿ç”¨é¢„è§ˆé™„ä»¶ï¼‰
  private hasDisplayAttachments(): boolean {
    if (this.isEditing) {
      return this.previewAttachments.length > 0
    }
    return this.message.hasAttachments()
  }

  // è·å–é™„ä»¶å›¾ç‰‡æ•°æ®æºï¼ˆä¼˜å…ˆ file://ï¼Œå…¶æ¬¡ base64ï¼‰
  private getAttachmentImageSource(attachment: MessageAttachment): string {
    if (attachment.filePath !== '') {
      return 'file://' + attachment.filePath
    }
    if (attachment.base64Data !== '') {
      return `data:${attachment.mimeType};base64,${attachment.base64Data}`
    }
    return ''
  }

  // æå–å›¾ç‰‡é™„ä»¶åœ¨åŸé™„ä»¶æ•°ç»„ä¸­çš„ç´¢å¼•ï¼ˆç”¨äºæ­£ç¡®æ˜ å°„é¢„è§ˆç´¢å¼•ï¼‰
  private getImageAttachmentIndices(attachments: MessageAttachment[]): number[] {
    const imageIndices: number[] = []
    for (let i = 0; i < attachments.length; i++) {
      if (attachments[i].type === AttachmentType.IMAGE) {
        imageIndices.push(i)
      }
    }
    return imageIndices
  }

  // ç”Ÿæˆä¸¤åˆ—ç½‘æ ¼è¡Œç´¢å¼•
  private buildImageGridRows(imageCount: number): number[] {
    const rows: number[] = []
    if (imageCount <= 0) {
      return rows
    }
    const rowCount = Math.ceil(imageCount / 2)
    for (let i = 0; i < rowCount; i++) {
      rows.push(i)
    }
    return rows
  }

  // æ¸…ç©ºç¿»è¯‘
  private clearTranslation(): void {
    this.showTranslation = false
    this.translatedText = ''
    this.currentTranslateLang = ''
  }

  // å°† hex é¢œè‰²å‘ç™½è‰²æ–¹å‘æ··åˆï¼ˆç”¨äºå¤šé€‰é€‰ä¸­æ€ï¼‰
  private lightenColor(hex: string, amount: number): string {
    let c = hex.replace('#', '')
    if (c.length === 3) {
      c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2]
    }
    const r = Math.min(255, Math.round(parseInt(c.substring(0, 2), 16) + (255 - parseInt(c.substring(0, 2), 16)) * amount))
    const g = Math.min(255, Math.round(parseInt(c.substring(2, 4), 16) + (255 - parseInt(c.substring(2, 4), 16)) * amount))
    const b = Math.min(255, Math.round(parseInt(c.substring(4, 6), 16) + (255 - parseInt(c.substring(4, 6), 16)) * amount))
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`
  }

  private openWebSheetForLink(title: string, src: string): boolean {
    let url = src.trim()
    if (url === '') {
      return false
    }
    if (url.startsWith('mailto:') || url.startsWith('tel:')) {
      return false
    }
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      // å…¼å®¹ markdown ä¸­çš„è£¸åŸŸåé“¾æ¥
      if (url.indexOf('://') < 0) {
        url = 'https://' + url
      } else {
        return false
      }
    }

    const trimmedTitle = title.trim()
    this.webSheetTitle = trimmedTitle
    this.webSheetUrl = url
    this.showWebSheet = true
    return true
  }

  @Builder
  WebSheetBuilder() {
    Column() {
      if (this.webSheetUrl !== '') {
        Web({ src: this.webSheetUrl, controller: this.sheetWebController })
          .width('100%')
          .layoutWeight(1)
      } else {
        Column() {
          Text($r('app.string.common_invalid_link'))
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }

  @Builder
  UserMessage() {
    Column() {
      Row() {
        Blank()

        Row() {
          Column() {
            // å›¾ç‰‡é™„ä»¶æ˜¾ç¤º
            if (this.hasDisplayAttachments()) {
              if (this.isEditing) {
                this.PreviewAttachments()
              } else {
                this.UserAttachments()
              }
            }

            // æ–‡æœ¬å†…å®¹
            if (this.getDisplayContent().length > 0) {
              Text(this.getDisplayContent())
                .fontSize(15)
                .fontColor(this.themeUserBubbleText)
                .lineHeight(22)
            }
          }
          .padding(this.hasDisplayAttachments() ? { left: 8, right: 8, top: 8, bottom: 8 } : { left: 14, right: 14, top: 10, bottom: 10 })
          .backgroundColor(this.isMultiSelectMode && this.isSelected
            ? this.lightenColor(this.themeUserBubble, 0.15)
            : this.themeUserBubble)
          .borderRadius({
            topLeft: 20,
            topRight: 20,
            bottomLeft: 20,
            bottomRight: 6
          })
          .clip(true)
          .constraintSize({ maxWidth: '75%' })
          .shadow({
            radius: this.isEditing ? 24 : 12,
            color: this.isEditing ? this.themePrimary + '80' : this.themePrimary + '20',
            offsetX: 0,
            offsetY: this.isEditing ? 6 : 4
          })
          .border({
            width: this.isEditing ? 2 : 0.5,
            color: this.isEditing ? '#FFFFFF' : 'rgba(255, 255, 255, 0.15)'
          })
          .animation({ duration: 200 })

          // å¤šé€‰é€‰ä¸­ç«–æ¡
          if (this.isMultiSelectMode && this.isSelected) {
            Column()
              .width(3)
              .borderRadius(1.5)
              .backgroundColor(this.themePrimary)
              .alignSelf(ItemAlign.Stretch)
              .margin({ left: 4 })
              .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))
          }
        }
        .onClick(() => {
          if (this.isMultiSelectMode) {
            this.onSelect(this.message.id)
          }
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)

      // ç”¨æˆ·æ¶ˆæ¯å·¥å…·æ 
      if (!this.isMultiSelectMode && !this.isEditing && this.message.content.length > 0) {
        Row() {
          Blank()

          // å¤åˆ¶
          SymbolGlyph($r('sys.symbol.checkmark_square_on_square'))
            .fontSize(14)
            .fontColor([$r('app.color.text_tertiary')])
            .onClick(() => { this.handleCopy() })

          // é‡æ–°ç”Ÿæˆ
          SymbolGlyph($r('sys.symbol.arrow_clockwise'))
            .fontSize(14)
            .fontColor([$r('app.color.text_tertiary')])
            .margin({ left: 16 })
            .onClick(() => { this.onRegenerate() })

          // ç¼–è¾‘
          SymbolGlyph($r('sys.symbol.square_and_pencil'))
            .fontSize(14)
            .fontColor([$r('app.color.text_tertiary')])
            .margin({ left: 16 })
            .onClick(() => { this.onEdit() })

          // æ›´å¤š
          SymbolGlyph($r('sys.symbol.dot_grid_2x2'))
            .fontSize(14)
            .fontColor([$r('app.color.text_tertiary')])
            .margin({ left: 16 })
            .bindMenu(this.UserMoreMenu())
        }
        .width('100%')
        .margin({ top: 6 })
      }

    }
    .width('100%')
    .alignItems(HorizontalAlign.End)
    .renderGroup(true)  // å‡å°‘æ¸²æŸ“æ‰¹æ¬¡ï¼Œä¼˜åŒ–æ€§èƒ½
  }

  // ç¼–è¾‘æ¨¡å¼ä¸‹çš„ç®€åŒ–é™„ä»¶é¢„è§ˆï¼ˆæ— æ‰‹åŠ¿äº¤äº’ï¼‰
  @Builder
  PreviewAttachments() {
    Column() {
      if (this.getImageAttachmentIndices(this.previewAttachments).length === 1) {
        this.CompactPreviewSingleImage(
          this.previewAttachments[this.getImageAttachmentIndices(this.previewAttachments)[0]],
          this.getDisplayContent().length > 0 ? 6 : 0
        )
      } else if (this.getImageAttachmentIndices(this.previewAttachments).length > 1) {
        Column({ space: this.compactImageGap }) {
          ForEach(this.buildImageGridRows(this.getImageAttachmentIndices(this.previewAttachments).length), (rowIndex: number) => {
            Row({ space: this.compactImageGap }) {
              this.CompactPreviewGridImage(
                this.previewAttachments[this.getImageAttachmentIndices(this.previewAttachments)[rowIndex * 2]]
              )

              if (rowIndex * 2 + 1 < this.getImageAttachmentIndices(this.previewAttachments).length) {
                this.CompactPreviewGridImage(
                  this.previewAttachments[this.getImageAttachmentIndices(this.previewAttachments)[rowIndex * 2 + 1]]
                )
              } else {
                Blank()
                  .layoutWeight(1)
              }
            }
            .width(this.compactImageContainerWidth)
          }, (rowIndex: number) => rowIndex.toString())
        }
        .margin({ bottom: this.getDisplayContent().length > 0 ? 6 : 0 })
      }
    }
  }

  @Builder
  CompactPreviewSingleImage(attachment: MessageAttachment, bottomMargin: number) {
    if (this.getAttachmentImageSource(attachment) !== '') {
      Image(this.getAttachmentImageSource(attachment))
        .width(this.compactImageContainerWidth)
        .height(this.compactImageMaxHeight)
        .objectFit(ImageFit.Contain)
        .borderRadius(12)
        .clip(true)
        .margin({ bottom: bottomMargin })
    }
  }

  @Builder
  CompactPreviewGridImage(attachment: MessageAttachment) {
    if (this.getAttachmentImageSource(attachment) !== '') {
      Image(this.getAttachmentImageSource(attachment))
        .width('100%')
        .height(this.compactImageMaxHeight)
        .objectFit(ImageFit.Contain)
        .borderRadius(12)
        .clip(true)
        .layoutWeight(1)
    }
  }

  @Builder
  CompactSingleImage(attachment: MessageAttachment, attachmentIndex: number, bottomMargin: number) {
    if (this.getAttachmentImageSource(attachment) !== '') {
      Image(this.getAttachmentImageSource(attachment))
        .width(this.compactImageContainerWidth)
        .height(this.compactImageMaxHeight)
        .objectFit(ImageFit.Contain)
        .borderRadius(12)
        .clip(true)
        .margin({ bottom: bottomMargin })
        .hitTestBehavior(HitTestMode.Block)
        .gesture(
          TapGesture({ count: 1 })
            .onAction(() => {
              hilog.info(DOMAIN, TAG, 'ğŸ–¼ï¸ å›¾ç‰‡ç‚¹å‡» (index: %{public}d, msgId: %{public}s)', attachmentIndex, this.message.id)
              this.handleImagePreview(attachmentIndex)
            })
        )
    }
  }

  @Builder
  CompactGridImage(attachment: MessageAttachment, attachmentIndex: number) {
    if (this.getAttachmentImageSource(attachment) !== '') {
      Image(this.getAttachmentImageSource(attachment))
        .width('100%')
        .height(this.compactImageMaxHeight)
        .objectFit(ImageFit.Contain)
        .borderRadius(12)
        .clip(true)
        .layoutWeight(1)
        .hitTestBehavior(HitTestMode.Block)
        .gesture(
          TapGesture({ count: 1 })
            .onAction(() => {
              hilog.info(DOMAIN, TAG, 'ğŸ–¼ï¸ å›¾ç‰‡ç‚¹å‡» (index: %{public}d, msgId: %{public}s)', attachmentIndex, this.message.id)
              this.handleImagePreview(attachmentIndex)
            })
        )
    }
  }

  @Builder
  UserAttachments() {
    Column() {
      if (this.getImageAttachmentIndices(this.message.attachments).length === 1) {
        this.CompactSingleImage(
          this.message.attachments[this.getImageAttachmentIndices(this.message.attachments)[0]],
          this.getImageAttachmentIndices(this.message.attachments)[0],
          this.message.content.length > 0 ? 6 : 0
        )
      } else if (this.getImageAttachmentIndices(this.message.attachments).length > 1) {
        Column({ space: this.compactImageGap }) {
          ForEach(this.buildImageGridRows(this.getImageAttachmentIndices(this.message.attachments).length), (rowIndex: number) => {
            Row({ space: this.compactImageGap }) {
              this.CompactGridImage(
                this.message.attachments[this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2]],
                this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2]
              )

              if (rowIndex * 2 + 1 < this.getImageAttachmentIndices(this.message.attachments).length) {
                this.CompactGridImage(
                  this.message.attachments[this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2 + 1]],
                  this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2 + 1]
                )
              } else {
                Blank()
                  .layoutWeight(1)
              }
            }
            .width(this.compactImageContainerWidth)
          }, (rowIndex: number) => rowIndex.toString())
        }
        .margin({ bottom: this.message.content.length > 0 ? 6 : 0 })
      }

      ForEach(this.message.attachments, (attachment: MessageAttachment, index: number) => {
        if (attachment.type === AttachmentType.FILE) {
          // æ–‡ä»¶é™„ä»¶
          Row() {
            SymbolGlyph($r('sys.symbol.doc'))
              .fontSize(18)
              .fontColor(['rgba(255,255,255,0.8)'])

            Text(attachment.name)
              .fontSize(12)
              .fontColor('rgba(255,255,255,0.9)')
              .margin({ left: 6 })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
          .padding(8)
          .backgroundColor('rgba(255,255,255,0.15)')
          .borderRadius(8)
          .margin({ bottom: this.message.content.length > 0 ? 6 : 0 })
        }
      }, (attachment: MessageAttachment, index: number) => attachment.id || attachment.filePath || index.toString())
    }
    .alignItems(HorizontalAlign.End)
  }

  @Builder
  AssistantAttachments() {
    Column() {
      if (this.getImageAttachmentIndices(this.message.attachments).length === 1) {
        this.CompactSingleImage(
          this.message.attachments[this.getImageAttachmentIndices(this.message.attachments)[0]],
          this.getImageAttachmentIndices(this.message.attachments)[0],
          8
        )
      } else if (this.getImageAttachmentIndices(this.message.attachments).length > 1) {
        Column({ space: this.compactImageGap }) {
          ForEach(this.buildImageGridRows(this.getImageAttachmentIndices(this.message.attachments).length), (rowIndex: number) => {
            Row({ space: this.compactImageGap }) {
              this.CompactGridImage(
                this.message.attachments[this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2]],
                this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2]
              )

              if (rowIndex * 2 + 1 < this.getImageAttachmentIndices(this.message.attachments).length) {
                this.CompactGridImage(
                  this.message.attachments[this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2 + 1]],
                  this.getImageAttachmentIndices(this.message.attachments)[rowIndex * 2 + 1]
                )
              } else {
                Blank()
                  .layoutWeight(1)
              }
            }
            .width(this.compactImageContainerWidth)
          }, (rowIndex: number) => rowIndex.toString())
        }
        .margin({ bottom: 8 })
      }

      ForEach(this.message.attachments, (attachment: MessageAttachment, index: number) => {
        if (attachment.type === AttachmentType.FILE) {
          // æ–‡ä»¶é™„ä»¶
          Row() {
            SymbolGlyph($r('sys.symbol.doc'))
              .fontSize(18)
              .fontColor([$r('app.color.text_tertiary')])

            Text(attachment.name)
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ left: 6 })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
          .padding(8)
          .backgroundColor($r('app.color.divider'))
          .borderRadius(8)
          .margin({ bottom: 8 })
        }
      }, (attachment: MessageAttachment, index: number) => attachment.id || attachment.filePath || index.toString())
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // å¤„ç†å›¾ç‰‡é¢„è§ˆç‚¹å‡»
  private handleImagePreview(clickedIndex: number): void {
    hilog.info(DOMAIN, TAG, 'ğŸ” handleImagePreview å¼€å§‹ (clickedIndex: %{public}d, msgId: %{public}s)', clickedIndex, this.message.id)
    // æ”¶é›†æ‰€æœ‰å›¾ç‰‡é™„ä»¶çš„è·¯å¾„
    const imageAttachments = this.message.getImageAttachments()
    const imagePaths: Array<string> = []

    for (let i = 0; i < imageAttachments.length; i++) {
      const attachment = imageAttachments[i]
      if (attachment.filePath !== '') {
        imagePaths.push('file://' + attachment.filePath)
      } else if (attachment.base64Data !== '') {
        imagePaths.push(`data:${attachment.mimeType};base64,${attachment.base64Data}`)
      }
    }

    if (imagePaths.length > 0) {
      // è®¡ç®—ç‚¹å‡»çš„å›¾ç‰‡åœ¨çº¯å›¾ç‰‡åˆ—è¡¨ä¸­çš„ç´¢å¼•
      let imageIndex = 0
      let imageCount = 0
      for (let i = 0; i < this.message.attachments.length; i++) {
        if (this.message.attachments[i].type === AttachmentType.IMAGE) {
          if (i === clickedIndex) {
            imageIndex = imageCount
            break
          }
          imageCount++
        }
      }
      hilog.info(DOMAIN, TAG, 'ğŸ” è°ƒç”¨ onImageClick (imagePaths: %{public}d, imageIndex: %{public}d)', imagePaths.length, imageIndex)
      this.onImageClick(imagePaths, imageIndex)
    }
  }

  // ç¿»è¯‘å­èœå•
  @Builder
  TranslateSubMenu() {
    Menu() {
      ForEach(this.translateLanguages, (lang: TranslateLanguage) => {
        MenuItem({ content: lang.nativeName })
          .onClick(() => { this.handleTranslate(lang.name) })
      }, (lang: TranslateLanguage) => lang.code)
    }
  }

  // AI æ¶ˆæ¯æ›´å¤šèœå•ï¼ˆåˆ†äº«/å¤šé€‰/åˆ é™¤ï¼‰
  @Builder
  AssistantMoreMenu() {
    Menu() {
      MenuItem({ symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.share')).fontSize(16), content: $r('app.string.menu_share') })
        .contentFont({ size: 14 })
        .onClick(() => { this.onShareMessage() })

      MenuItem({ symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.checkmark_circle')).fontSize(16), content: $r('app.string.menu_multi_select') })
        .contentFont({ size: 14 })
        .onClick(() => { this.onEnterMultiSelect(this.message.id) })

      MenuItem({ symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.trash')).fontSize(16), content: $r('app.string.delete') })
        .contentFont({ size: 14 })
        .contentFontColor($r('app.color.status_error'))
        .onClick(() => { this.onDelete() })
    }
  }

  // ç”¨æˆ·æ¶ˆæ¯æ›´å¤šèœå•ï¼ˆåˆ†äº«/å¤šé€‰/åˆ é™¤ï¼‰
  @Builder
  UserMoreMenu() {
    Menu() {
      MenuItem({ symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.share')).fontSize(16), content: $r('app.string.menu_share') })
        .contentFont({ size: 14 })
        .onClick(() => { this.onShareMessage() })

      MenuItem({ symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.checkmark_circle')).fontSize(16), content: $r('app.string.menu_multi_select') })
        .contentFont({ size: 14 })
        .onClick(() => { this.onEnterMultiSelect(this.message.id) })

      MenuItem({ symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.trash')).fontSize(16), content: $r('app.string.delete') })
        .contentFont({ size: 14 })
        .contentFontColor($r('app.color.status_error'))
        .onClick(() => { this.onDelete() })
    }
  }

  @Builder
  AssistantMessage() {
    Row() {
      // å¤šé€‰é€‰ä¸­ç«–æ¡
      if (this.isMultiSelectMode && this.isSelected) {
        Column()
          .width(3)
          .borderRadius(1.5)
          .backgroundColor(this.themePrimary)
          .alignSelf(ItemAlign.Stretch)
          .margin({ right: 4 })
          .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))
      }

      Column() {
        // æ¶ˆæ¯å¤´éƒ¨ï¼šå›¾æ ‡ + æ¨¡å‹å + æ—¶é—´ï¼ˆæ°´å¹³æ’åˆ—ï¼‰
        // åªåœ¨ showHeader ä¸º true æ—¶æ˜¾ç¤º
        if (this.showHeader) {
          Row() {
            // æ¨¡å‹å›¾æ ‡ + æ·¡è‰²åœ†å½¢èƒŒæ™¯
            Column() {
              if (this.getCurrentMessageModelIconResourcePath() !== '') {
                Image(this.getCurrentMessageModelIconResourcePath())
                  .width(18)
                  .height(18)
                  .objectFit(ImageFit.Contain)
              } else {
                SymbolGlyph($r('sys.symbol.ai_edit'))
                  .fontSize(16)
                  .fontColor([$r('app.color.primary')])
              }
            }
            .width(30)
            .height(30)
            .borderRadius(10)
            .backgroundColor($r('app.color.model_icon_bg'))
            .border({ width: 0.5, color: $r('app.color.bubble_border') })
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)

            // æ¨¡å‹åç§°
            Text(this.message.modelName || 'AI')
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
              .margin({ left: 10 })

            Blank()
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)
        }

        // å†…å®¹åŒºåŸŸ - æ— æ°”æ³¡ï¼Œå…¨å®½æ˜¾ç¤º
        Column() {
            // ========== å·¥å…·è°ƒç”¨åŒºåŸŸ ==========
            if (this.message.hasToolCalls()) {
              ForEach(this.message.toolCalls, (toolCall: ToolCall, index: number) => {
                ToolCallCard({
                  toolCall: toolCall,
                  toolResult: index < this.message.toolResults.length ? this.message.toolResults[index] : null,
                  isExecuting: this.message.isGenerating && index >= this.message.toolResults.length
                })
                  .margin({ bottom: 6 })
              }, (toolCall: ToolCall, index: number) => toolCall.id + '_' + index.toString())
            }

            // ========== æœç´¢å¼•ç”¨åŒºåŸŸ ==========
            if (this.message.hasSearchReferences()) {
              SearchReferenceCard({
                query: this.extractSearchQuery(),
                searchEngine: this.message.searchEngine || 'Web',
                references: this.message.searchReferences,
                sourceLabel: this.getSearchSourceLabel()
              })
                .margin({ bottom: 6 })
            }

            // ========== é™„ä»¶åŒºåŸŸï¼ˆAI ç”Ÿæˆçš„å›¾ç‰‡ï¼‰ ==========
            if (this.message.hasAttachments()) {
              this.AssistantAttachments()
            }

            // ========== æ¨ç†å†…å®¹åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰ ==========
            if (this.message.hasReasoningContent()) {
              this.ReasoningSection()
            }

            // ========== åŠ è½½çŠ¶æ€æˆ–ä¸»è¦å†…å®¹åŒºåŸŸ ==========
            if (this.message.content.length === 0 && this.message.reasoningContent.length === 0 &&
                (this.message.isGenerating || this.message.isSearching)) {
              if (this.message.isSearching) {
                this.SearchingIndicatorInline()
              } else {
                this.TypingIndicator()
              }
            } else {
              if (!this.message.isGenerating && this.hasHtmlBlocks(this.message.content)) {
                ForEach(this.splitContentToSegments(this.message.content),
                  (segment: ContentSegment, index: number) => {
                    if (segment.isHtml) {
                      HtmlPreviewCard({
                        htmlCode: segment.content,
                        onCopyCode: (code: string) => {
                          this.copyToClipboard(code)
                          showToast(this.getUIContext(), $r('app.string.copy_success'))
                        }
                      })
                    } else {
                      Markdown({
                        controller: this.markdownController,
                        text: this.convertTaskListToReadonly(segment.content)
                      })
                        .width('100%')
                        .backgroundColor(Color.Transparent)
                    }
                  },
                  (segment: ContentSegment, index: number) => {
                    return 'segment_' + this.message.id + '_' + index.toString()
                  }
                )
              } else {
                Markdown({
                  controller: this.markdownController,
                  text: this.convertTaskListToReadonly(this.message.content)
                })
                  .width('100%')
                  .backgroundColor(Color.Transparent)
                  .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))
              }
            }

            // ========== ç¿»è¯‘ç»“æœåŒºåŸŸï¼ˆåµŒå…¥å¼å¯æŠ˜å å¡ç‰‡ï¼‰ ==========
            if (this.showTranslation) {
              this.TranslationCard()
            }

            // ========== å·¥å…·æ  ==========
            if ((this.message.content.length > 0 || !this.message.isGenerating) && !this.message.isSearching && !this.isMultiSelectMode) {
              Row() {
                // å¤åˆ¶
                SymbolGlyph($r('sys.symbol.checkmark_square_on_square'))
                  .fontSize(14)
                  .fontColor([$r('app.color.text_tertiary')])
                  .onClick(() => { this.handleCopy() })

                // é‡æ–°ç”Ÿæˆ
                SymbolGlyph($r('sys.symbol.arrow_clockwise'))
                  .fontSize(14)
                  .fontColor([$r('app.color.text_tertiary')])
                  .margin({ left: 16 })
                  .onClick(() => { this.onRegenerate() })

                // æœ—è¯»
                SymbolGlyph((this.speakingMessageId === this.message.id) ? $r('sys.symbol.pause') : $r('sys.symbol.speaker_wave_2'))
                  .fontSize(14)
                  .fontColor([(this.speakingMessageId === this.message.id) ? $r('app.color.primary') : $r('app.color.text_tertiary')])
                  .margin({ left: 16 })
                  .onClick(() => {
                    if ((this.speakingMessageId === this.message.id)) { this.onTTSStop() } else { this.onTTS(this.message.id, this.message.content) }
                  })

                // ç¿»è¯‘
                SymbolGlyph($r('sys.symbol.translate'))
                  .fontSize(14)
                  .fontColor([$r('app.color.text_tertiary')])
                  .margin({ left: 16 })
                  .bindMenu(this.TranslateSubMenu())

                // æ›´å¤š
                SymbolGlyph($r('sys.symbol.dot_grid_2x2'))
                  .fontSize(14)
                  .fontColor([$r('app.color.text_tertiary')])
                  .margin({ left: 16 })
                  .bindMenu(this.AssistantMoreMenu())

                Blank()
              }
              .width('100%')
              .margin({ top: 6 })
            }
          }
          .width('100%')
          .margin({ top: this.showHeader ? 8 : 0 })
          .padding({ left: 14, right: 14, top: 12, bottom: 10 })
          .backgroundColor(this.isMultiSelectMode && this.isSelected
            ? this.themePrimary + '15'
            : this.themeAiBubble)
          .borderRadius(16)
          .border({ width: 0.5, color: $r('app.color.bubble_border') })
          .shadow({ radius: 4, color: 'rgba(0, 0, 0, 0.04)', offsetX: 0, offsetY: 1 })
          .clip(true)
          .renderGroup(true)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .onClick(() => {
        if (this.isMultiSelectMode) {
          this.onSelect(this.message.id)
        } else if ((this.speakingMessageId === this.message.id)) {
          this.onTTSStop()
        }
      })
    }
    .width('100%')
    .constraintSize({ maxWidth: '92%' })
    .alignItems(VerticalAlign.Top)
  }

  // ç­‰å¾… AI å“åº”çš„è·³åŠ¨ç‚¹åŠ¨ç”»
  @Builder
  TypingIndicator() {
    Row() {
      // ä¸‰ä¸ªè·³åŠ¨çš„ç‚¹
      Row({ space: 5 }) {
        // ç¬¬ä¸€ä¸ªç‚¹
        Column()
          .width(7)
          .height(7)
          .borderRadius(3.5)
          .backgroundColor(this.themePrimary)
          .scale({ x: this.dot1Scale, y: this.dot1Scale })
          .opacity(0.5 + this.dot1Scale * 0.5)

        // ç¬¬äºŒä¸ªç‚¹
        Column()
          .width(7)
          .height(7)
          .borderRadius(3.5)
          .backgroundColor(this.themePrimary)
          .scale({ x: this.dot2Scale, y: this.dot2Scale })
          .opacity(0.5 + this.dot2Scale * 0.5)

        // ç¬¬ä¸‰ä¸ªç‚¹
        Column()
          .width(7)
          .height(7)
          .borderRadius(3.5)
          .backgroundColor(this.themePrimary)
          .scale({ x: this.dot3Scale, y: this.dot3Scale })
          .opacity(0.5 + this.dot3Scale * 0.5)
      }
      .padding({ left: 14, right: 14, top: 10, bottom: 10 })
      .backgroundColor(this.themeAiBubble)
      .borderRadius({
        topLeft: 4,
        topRight: 18,
        bottomLeft: 18,
        bottomRight: 18
      })
      .clip(true)
      .shadow({
        radius: 8,
        color: 'rgba(0, 0, 0, 0.05)',
        offsetX: 0,
        offsetY: 1
      })
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
    // è·³åŠ¨ç‚¹æ·¡å‡ºè¿‡æ¸¡åŠ¨ç”»
    .transition(TransitionEffect.OPACITY.animation({ duration: 150 }))
  }

  // æœç´¢çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆAI æ¶ˆæ¯åŒºåŸŸå†…è”æ˜¾ç¤ºï¼‰
  @Builder
  SearchingIndicatorInline() {
    Row() {
      Row({ space: 6 }) {
        SymbolGlyph($r('sys.symbol.magnifyingglass'))
          .fontSize(13)
          .fontColor([this.themePrimary])

        Text(this.getSearchingIndicatorText())
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
          .constraintSize({ maxWidth: 150 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // ä¸‰ä¸ªè·³åŠ¨çš„ç‚¹
        Row({ space: 2 }) {
          Column()
            .width(4)
            .height(4)
            .borderRadius(2)
            .backgroundColor(this.themePrimary)
            .scale({ x: this.dot1Scale, y: this.dot1Scale })

          Column()
            .width(4)
            .height(4)
            .borderRadius(2)
            .backgroundColor(this.themePrimary)
            .scale({ x: this.dot2Scale, y: this.dot2Scale })

          Column()
            .width(4)
            .height(4)
            .borderRadius(2)
            .backgroundColor(this.themePrimary)
            .scale({ x: this.dot3Scale, y: this.dot3Scale })
        }
      }
      .constraintSize({ maxWidth: 220 })
      .padding({ left: 10, right: 10, top: 5, bottom: 5 })
      .backgroundColor(this.themeAiBubble)
      .borderRadius(14)
      .clip(true)
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
    // æœç´¢æŒ‡ç¤ºå™¨æ·¡å‡ºè¿‡æ¸¡åŠ¨ç”»
    .transition(TransitionEffect.OPACITY.animation({ duration: 150 }))
  }

  // ç¿»è¯‘ç»“æœå¡ç‰‡ï¼ˆåµŒå…¥å¼å¯æŠ˜å ï¼‰
  @Builder
  TranslationCard() {
    Column() {
      // ç¿»è¯‘æ ‡é¢˜æ ï¼ˆç‚¹å‡»å¯æŠ˜å ï¼‰
      Row() {
        SymbolGlyph($r('sys.symbol.translate'))
          .fontSize(14)
          .fontColor([$r('app.color.text_secondary')])

        Text($r('app.string.translation_label'))
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_secondary'))
          .margin({ left: 6 })

        Blank()

        // å±•å¼€/æŠ˜å ç®­å¤´
        SymbolGlyph($r('sys.symbol.chevron_down'))
          .fontSize(14)
          .fontColor([$r('app.color.text_tertiary')])
          .rotate({ angle: this.isTranslationExpanded ? 0 : -90 })
          .animation({ duration: 200, curve: Curve.EaseOut })
      }
      .width('100%')
      .height(36)
      .padding({ left: 12, right: 12 })
      .onClick(() => {
        this.getUIContext().animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
          this.isTranslationExpanded = !this.isTranslationExpanded
        })
      })

      // ç¿»è¯‘å†…å®¹
      if (this.isTranslationExpanded) {
        Column() {
          if (this.isTranslating) {
            Row() {
              LoadingProgress()
                .width(14)
                .height(14)
                .color($r('app.color.primary'))
              Text($r('app.string.translation_loading'))
                .fontSize(13)
                .fontColor($r('app.color.text_secondary'))
                .margin({ left: 8 })
            }
            .padding({ left: 12, right: 12, bottom: 12 })
          } else if (this.translatedText !== '') {
            Column() {
              Markdown({
                controller: this.translationMarkdownController,
                text: this.convertTaskListToReadonly(this.translatedText)
              })
                .constraintSize({ maxWidth: '100%' })
                .backgroundColor(Color.Transparent)
            }
            .width('100%')
            .padding({ left: 12, right: 12, bottom: 12 })
          }
        }
        .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))
      }
    }
    .width('100%')
    .margin({ top: 8 })
    .backgroundColor($r('app.color.divider'))
    .borderRadius(12)
    .clip(true)
  }

  // æ¨ç†å†…å®¹åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰
  @Builder
  ReasoningSection() {
    Column() {
      // æ¨ç†æ ‡é¢˜æ ï¼ˆç‚¹å‡»å¯æŠ˜å /å±•å¼€ï¼‰
      Row() {
        // æ€è€ƒå›¾æ ‡
        SymbolGlyph($r('sys.symbol.lightbulb'))
          .fontSize(14)
          .fontColor([this.message.isGenerating ? this.themePrimary : $r('app.color.text_secondary')])

        // æ ‡é¢˜æ–‡æœ¬ï¼šæ ¹æ®ç”ŸæˆçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹
        if (this.message.isGenerating) {
          // æ­£åœ¨æ€è€ƒçŠ¶æ€ï¼šæ˜¾ç¤ºè·³åŠ¨ç‚¹åŠ¨ç”»
          Row({ space: 4 }) {
            Text($r('app.string.reasoning_thinking'))
              .fontSize(12)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.themePrimary)

            // ä¸‰ä¸ªè·³åŠ¨çš„ç‚¹
            Row({ space: 2 }) {
              Column()
                .width(4)
                .height(4)
                .borderRadius(2)
                .backgroundColor(this.themePrimary)
                .scale({ x: this.dot1Scale, y: this.dot1Scale })

              Column()
                .width(4)
                .height(4)
                .borderRadius(2)
                .backgroundColor(this.themePrimary)
                .scale({ x: this.dot2Scale, y: this.dot2Scale })

              Column()
                .width(4)
                .height(4)
                .borderRadius(2)
                .backgroundColor(this.themePrimary)
                .scale({ x: this.dot3Scale, y: this.dot3Scale })
            }
          }
          .margin({ left: 6 })
        } else {
          // é™æ€çŠ¶æ€ï¼šæ˜¾ç¤º"æ€è€ƒè¿‡ç¨‹"
          Text($r('app.string.reasoning_process'))
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 6 })
        }

        Blank()

        // å±•å¼€/æŠ˜å çŠ¶æ€æç¤º
        Text(this.isReasoningExpanded ? $r('app.string.common_collapse') : $r('app.string.common_expand'))
          .fontSize(11)
          .fontColor($r('app.color.text_secondary'))

        // å±•å¼€/æŠ˜å ç®­å¤´
        SymbolGlyph($r('sys.symbol.chevron_down'))
          .fontSize(12)
          .fontColor([$r('app.color.text_secondary')])
          .rotate({ angle: this.isReasoningExpanded ? 180 : 0 })
          .animation({ duration: 200, curve: Curve.EaseOut })
          .margin({ left: 4 })
      }
      .width('100%')
      .height(36)
      .padding({ left: 10, right: 10 })
      .backgroundColor($r('app.color.divider'))
      .borderRadius(8)
      .clip(true)
      .onClick(() => {
        // ç”Ÿæˆè¿‡ç¨‹ä¸­ç¦æ­¢æ‰‹åŠ¨æŠ˜å 
        if (!this.message.isGenerating) {
          // å…ˆæ›´æ–°çŠ¶æ€ï¼ˆè§¦å‘ UI åˆ·æ–°ï¼‰
          this.isReasoningExpanded = !this.isReasoningExpanded
          // å†æ‰§è¡ŒåŠ¨ç”»
          this.getUIContext().animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
            // åŠ¨ç”»å‚æ•°å·²ç»é€šè¿‡çŠ¶æ€å˜åŒ–è‡ªåŠ¨åº”ç”¨
          })
        }
      })

      // æ¨ç†å†…å®¹ï¼ˆå¯æŠ˜å ï¼‰ï¼šç”Ÿæˆä¸­è‡ªåŠ¨å±•å¼€ï¼Œå®Œæˆåç”± isReasoningExpanded æ§åˆ¶
      if (this.isReasoningExpanded || (this.message.isGenerating && this.message.reasoningContent.length > 0)) {
        Column() {
          Markdown({
            controller: this.reasoningMarkdownController,
            text: this.convertTaskListToReadonly(this.message.reasoningContent)
          })
            .constraintSize({ maxWidth: '100%' })
            .backgroundColor(Color.Transparent)
        }
        .width('100%')
        .padding({ left: 10, right: 10, top: 8, bottom: 8 })
        .backgroundColor($r('app.color.divider'))
        .borderRadius({ topLeft: 0, topRight: 0, bottomLeft: 8, bottomRight: 8 })
        .clip(true)
        .margin({ top: -8 })
        .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))
      }
    }
    .width('100%')
    .margin({ bottom: 4 })
  }

  /**
   * å°† Markdown ä»»åŠ¡åˆ—è¡¨è¯­æ³•è½¬æ¢ä¸ºåªè¯»å­—ç¬¦
   * é¿å… lv-markdown-in æ¸²æŸ“å‡ºå¯äº¤äº’çš„ checkbox
   * - [ ] â†’ - â˜ (ç©ºå¿ƒæ–¹æ¡†)
   * - [x] æˆ– - [X] â†’ - â˜‘ (å‹¾é€‰æ–¹æ¡†)
   */
  private convertTaskListToReadonly(content: string): string {
    if (content.length === 0) {
      return content
    }
    // æ›¿æ¢æœªå®Œæˆä»»åŠ¡: - [ ] æˆ– * [ ]
    let result = content.replace(/^(\s*[-*])\s*\[ \]/gm, '$1 â˜')
    // æ›¿æ¢å·²å®Œæˆä»»åŠ¡: - [x] æˆ– - [X] æˆ– * [x] æˆ– * [X]
    result = result.replace(/^(\s*[-*])\s*\[[xX]\]/gm, '$1 â˜‘')
    return result
  }

  // æå–æœç´¢æŸ¥è¯¢å†…å®¹
  private extractSearchQuery(): string {
    if (this.message.searchQuery !== '') {
      return this.message.searchQuery
    }
    if (this.message.searchReferences.length > 0) {
      return 'æœç´¢ç»“æœ'
    }
    return ''
  }

  private getSearchSourceLabel(): string {
    const source = this.message.searchSource.trim()
    if (source === 'tool') {
      return 'å·¥å…·è°ƒç”¨'
    }
    if (source === 'manual') {
      return 'æ‰‹åŠ¨æœç´¢'
    }
    // å…¼å®¹æ—§æ•°æ®ï¼šæ²¡æœ‰æŒä¹…åŒ– searchSource æ—¶ï¼Œç”¨æ˜¯å¦å­˜åœ¨ toolCalls åšæ¨æ–­
    return this.message.hasToolCalls() ? 'å·¥å…·è°ƒç”¨' : 'æ‰‹åŠ¨æœç´¢'
  }

  private getSearchingIndicatorText(): string {
    const engine = this.message.searchEngine.trim()
    if (this.message.searchQuery !== '') {
      if (engine !== '') {
        return `æˆ‘å°†ä¸ºä½ é€šè¿‡${engine}æŸ¥è¯¢ï¼š${this.message.searchQuery}`
      }
      return `æˆ‘å°†ä¸ºä½ æŸ¥è¯¢ï¼š${this.message.searchQuery}`
    }
    if (engine !== '') {
      return `æ­£åœ¨é€šè¿‡${engine}æŸ¥è¯¢...`
    }
    return 'æ­£åœ¨æŸ¥è¯¢...'
  }

  private handleCopy() {
    try {
      const pasteboardData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, this.message.content)
      const systemPasteboard = pasteboard.getSystemPasteboard()
      systemPasteboard.setData(pasteboardData)
      showToast(this.getUIContext(), $r('app.string.copy_success'))
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Copy message failed: ${JSON.stringify(error)}`)
    }
  }

  // å¤åˆ¶æŒ‡å®šæ–‡æœ¬åˆ°å‰ªè´´æ¿ï¼ˆç”¨äºä»£ç å—å¤åˆ¶ï¼‰
  private copyToClipboard(text: string) {
    try {
      const pasteboardData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, text)
      const systemPasteboard = pasteboard.getSystemPasteboard()
      systemPasteboard.setData(pasteboardData)
      showToast(this.getUIContext(), $r('app.string.copy_success'))
    } catch (error) {
      hilog.error(DOMAIN, TAG, `Copy code failed: ${JSON.stringify(error)}`)
    }
  }
}
