/**
 * é¢„è®¾ä¾›åº”å•†é…ç½®
 * å®šä¹‰å†…ç½®çš„æ¨¡å‹ä¾›åº”å•†ï¼Œè¿™äº›ä¾›åº”å•†ä¸å¯åˆ é™¤
 */

import { ProviderType, ApiStyle } from '../models/ChatModels'

// é¢„è®¾ä¾›åº”å•†é…ç½®æ¥å£
export interface PresetProviderConfig {
  id: string
  name: string
  type: ProviderType
  apiStyle: ApiStyle
  baseUrl: string
  iconPath: string      // SVG å›¾æ ‡è·¯å¾„ï¼ˆå·²å¼ƒç”¨ï¼Œç½®ç©ºï¼‰
  brandColorHex: string // å“ç‰Œè‰²ï¼ˆåå…­è¿›åˆ¶ï¼‰
  presetApiKey?: string // é¢„è®¾ API Keyï¼ˆå¯é€‰ï¼Œç”¨æˆ·ä¸å¡«æ—¶ä½¿ç”¨ï¼‰
  textIcon: string      // æ–‡å­—å›¾æ ‡å†…å®¹
  textIconBgColor: string // æ–‡å­—å›¾æ ‡èƒŒæ™¯è‰²
}

// é¢„è®¾ä¾›åº”å•†åˆ—è¡¨ï¼ˆä¸»æµå‚å•†ï¼Œä¸å¯åˆ é™¤ï¼‰
const PRESET_PROVIDERS: PresetProviderConfig[] = [
  {
    id: 'openai',
    name: 'OpenAI',
    type: ProviderType.OPENAI,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://api.openai.com/v1',
    iconPath: '',
    brandColorHex: '#10A37F',
    textIcon: 'AI',
    textIconBgColor: '#10A37F'
  },
  {
    id: 'anthropic',
    name: 'Claude',
    type: ProviderType.ANTHROPIC,
    apiStyle: ApiStyle.ANTHROPIC,
    baseUrl: 'https://api.anthropic.com',
    iconPath: '',
    brandColorHex: '#D97757',
    textIcon: 'C',
    textIconBgColor: '#D97757'
  },
  {
    id: 'deepseek',
    name: 'DeepSeek',
    type: ProviderType.DEEPSEEK,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://api.deepseek.com/v1',
    iconPath: '',
    brandColorHex: '#4D6BFE',
    textIcon: 'DS',
    textIconBgColor: '#4D6BFE'
  },
  {
    id: 'gemini',
    name: 'Gemini',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.GOOGLE,
    baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
    iconPath: '',
    brandColorHex: '#4285F4',
    textIcon: 'G',
    textIconBgColor: '#4285F4'
  },
  {
    id: 'openrouter',
    name: 'OpenRouter',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://openrouter.ai/api/v1',
    iconPath: '',
    brandColorHex: '#6366F1',
    textIcon: 'OR',
    textIconBgColor: '#6366F1'
  },
  {
    id: 'siliconflow',
    name: 'ç¡…åŸºæµåŠ¨',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://api.siliconflow.cn/v1',
    iconPath: '',
    brandColorHex: '#7C3AED',
    textIcon: 'SF',
    textIconBgColor: '#7C3AED'
  },
  {
    id: 'qwen',
    name: 'é˜¿é‡Œäº‘ç™¾ç‚¼',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
    iconPath: '',
    brandColorHex: '#615CED',
    textIcon: 'Q',
    textIconBgColor: '#615CED'
  },
  {
    id: 'zhipu',
    name: 'æ™ºè°± AI',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://open.bigmodel.cn/api/paas/v4',
    iconPath: '',
    brandColorHex: '#3B82F6',
    textIcon: 'Z',
    textIconBgColor: '#3B82F6'
  },
  {
    id: 'doubao',
    name: 'ç«å±±å¼•æ“',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://ark.cn-beijing.volces.com/api/v3',
    iconPath: '',
    brandColorHex: '#3370FF',
    textIcon: 'D',
    textIconBgColor: '#3370FF'
  },
  {
    id: 'minimax',
    name: 'MiniMax',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://api.minimax.chat/v1',
    iconPath: '',
    brandColorHex: '#00D68F',
    textIcon: 'M',
    textIconBgColor: '#00D68F'
  },
  {
    id: 'aihubmix',
    name: 'AiHubMix',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://aihubmix.com/v1',
    iconPath: '',
    brandColorHex: '#F59E0B',
    textIcon: 'AH',
    textIconBgColor: '#F59E0B'
  },
  {
    id: 'grok',
    name: 'Grok',
    type: ProviderType.CUSTOM,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'https://api.x.ai/v1',
    iconPath: '',
    brandColorHex: '#000000',
    textIcon: 'G',
    textIconBgColor: '#000000'
  },
  {
    id: 'ollama',
    name: 'Ollama',
    type: ProviderType.OLLAMA,
    apiStyle: ApiStyle.OPENAI,
    baseUrl: 'http://localhost:11434/v1',
    iconPath: '',
    brandColorHex: '#FFFFFF',
    textIcon: 'ğŸ¦™',
    textIconBgColor: ''
  }
]

// é¢„è®¾ä¾›åº”å•† ID é›†åˆï¼ˆç”¨äºå¿«é€Ÿåˆ¤æ–­ï¼‰
const PRESET_PROVIDER_IDS: Set<string> = new Set(PRESET_PROVIDERS.map(p => p.id))

/**
 * è·å–æ‰€æœ‰é¢„è®¾ä¾›åº”å•†é…ç½®
 */
export function getPresetProviders(): PresetProviderConfig[] {
  return PRESET_PROVIDERS
}

/**
 * æ ¹æ® ID è·å–é¢„è®¾ä¾›åº”å•†é…ç½®
 */
export function getPresetProviderById(id: string): PresetProviderConfig | null {
  for (let i = 0; i < PRESET_PROVIDERS.length; i++) {
    if (PRESET_PROVIDERS[i].id === id) {
      return PRESET_PROVIDERS[i]
    }
  }
  return null
}

/**
 * åˆ¤æ–­æ˜¯å¦ä¸ºé¢„è®¾ä¾›åº”å•†
 */
export function isPresetProvider(providerId: string): boolean {
  return PRESET_PROVIDER_IDS.has(providerId)
}

/**
 * è·å–ä¾›åº”å•†å›¾æ ‡è·¯å¾„
 * @param providerId ä¾›åº”å•† ID
 * @returns å›¾æ ‡æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸æ˜¯é¢„è®¾ä¾›åº”å•†åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²
 */
export function getPresetProviderIconPath(providerId: string): string {
  const preset = getPresetProviderById(providerId)
  if (preset !== null) {
    return preset.iconPath
  }
  return ''
}

/**
 * è·å–ä¾›åº”å•†å“ç‰Œè‰²
 * @param providerId ä¾›åº”å•† ID
 * @returns å“ç‰Œè‰²åå…­è¿›åˆ¶å€¼ï¼Œå¦‚æœä¸æ˜¯é¢„è®¾ä¾›åº”å•†åˆ™è¿”å›é»˜è®¤è‰²
 */
export function getPresetProviderBrandColor(providerId: string): string {
  const preset = getPresetProviderById(providerId)
  if (preset !== null) {
    return preset.brandColorHex
  }
  return '#007DFF' // é»˜è®¤ä¸»é¢˜è‰²
}

/**
 * è·å–ä¾›åº”å•†çš„æœ‰æ•ˆ API Key
 * å¦‚æœç”¨æˆ·é…ç½®äº† API Key åˆ™ä½¿ç”¨ç”¨æˆ·çš„ï¼Œå¦åˆ™ä½¿ç”¨é¢„è®¾çš„
 * @param providerId ä¾›åº”å•† ID
 * @param userApiKey ç”¨æˆ·é…ç½®çš„ API Key
 * @returns æœ‰æ•ˆçš„ API Key
 */
export function getEffectiveApiKey(providerId: string, userApiKey: string): string {
  // å¦‚æœç”¨æˆ·é…ç½®äº† API Keyï¼Œä¼˜å…ˆä½¿ç”¨
  if (userApiKey !== '') {
    return userApiKey
  }
  // å¦åˆ™å°è¯•ä½¿ç”¨é¢„è®¾çš„ API Key
  const preset = getPresetProviderById(providerId)
  if (preset !== null && preset.presetApiKey !== undefined) {
    return preset.presetApiKey
  }
  return ''
}

/**
 * è·å–æœªé…ç½®çš„é¢„ç½®æœåŠ¡å•†åˆ—è¡¨
 * @param configuredIds å·²é…ç½®çš„æœåŠ¡å•† ID åˆ—è¡¨
 * @returns æœªé…ç½®çš„é¢„ç½®æœåŠ¡å•†é…ç½®åˆ—è¡¨
 */
export function getUnconfiguredPresetProviders(configuredIds: string[]): PresetProviderConfig[] {
  const configuredSet = new Set<string>(configuredIds)
  const result: PresetProviderConfig[] = []
  for (let i = 0; i < PRESET_PROVIDERS.length; i++) {
    const preset = PRESET_PROVIDERS[i]
    if (!configuredSet.has(preset.id)) {
      result.push(preset)
    }
  }
  return result
}
