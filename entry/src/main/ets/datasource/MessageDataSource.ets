import { ChatMessage } from '../models/ChatModels'
import { hilog } from '@kit.PerformanceAnalysisKit'

const DOMAIN = 0x0003
const TAG = 'MessageDataSource'

// æ•°æ®æºç»Ÿè®¡ä¿¡æ¯
interface DataSourceStats {
  totalCount: number
  listenerCount: number
}

/**
 * æ¶ˆæ¯æ•°æ®æº
 * å®ç° IDataSource æ¥å£ï¼Œç”¨äº LazyForEach çš„æ•°æ®æ‡’åŠ è½½
 */
export class MessageDataSource implements IDataSource {
  // æ•°æ®ç›‘å¬å™¨åˆ—è¡¨
  private listeners: DataChangeListener[] = []
  // æ¶ˆæ¯æ•°æ®æ•°ç»„
  private dataArray: ChatMessage[] = []

  constructor(messages: ChatMessage[] = []) {
    this.dataArray = messages
    hilog.info(DOMAIN, TAG, 'ğŸš€ MessageDataSource åˆå§‹åŒ– (æ¶ˆæ¯æ•°: %{public}d)', this.dataArray.length)
  }

  /**
   * è·å–æ•°æ®æ€»æ•°
   */
  totalCount(): number {
    return this.dataArray.length
  }

  /**
   * è·å–æŒ‡å®šç´¢å¼•çš„æ•°æ®
   */
  getData(index: number): ChatMessage {
    return this.dataArray[index]
  }

  /**
   * è·å–æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨äºè®¿é—®å®Œæ•´æ•°æ®ï¼‰
   */
  getAllMessages(): ChatMessage[] {
    return this.dataArray
  }

  /**
   * è®¾ç½®æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨äºåˆå§‹åŒ–ï¼‰
   * æ³¨æ„ï¼šåˆ›å»ºæ•°ç»„å‰¯æœ¬ï¼Œé¿å…ä¸å¤–éƒ¨æ•°ç»„å…±äº«å¼•ç”¨
   */
  setAllMessages(messages: ChatMessage[]): void {
    // åˆ›å»ºæ•°ç»„å‰¯æœ¬ï¼Œé¿å…ä¸å¤–éƒ¨æ•°ç»„å…±äº«å¼•ç”¨å¯¼è‡´é‡å¤æ·»åŠ 
    this.dataArray = []
    for (let i = 0; i < messages.length; i++) {
      this.dataArray.push(messages[i])
    }
    hilog.info(DOMAIN, TAG, 'ğŸ“¥ è®¾ç½®æ¶ˆæ¯åˆ—è¡¨ (æ€»æ•°: %{public}d)', this.dataArray.length)
    this.notifyDataReload()
  }

  /**
   * æ³¨å†Œæ•°æ®å˜åŒ–ç›‘å¬å™¨
   */
  registerDataChangeListener(listener: DataChangeListener): void {
    if (this.listeners.indexOf(listener) < 0) {
      this.listeners.push(listener)
      hilog.debug(DOMAIN, TAG, 'â• æ³¨å†Œç›‘å¬å™¨ (å½“å‰ç›‘å¬å™¨æ•°: %{public}d)', this.listeners.length)
    }
  }

  /**
   * æ³¨é”€æ•°æ®å˜åŒ–ç›‘å¬å™¨
   */
  unregisterDataChangeListener(listener: DataChangeListener): void {
    const pos = this.listeners.indexOf(listener)
    if (pos >= 0) {
      this.listeners.splice(pos, 1)
      hilog.debug(DOMAIN, TAG, 'â– æ³¨é”€ç›‘å¬å™¨ (å½“å‰ç›‘å¬å™¨æ•°: %{public}d)', this.listeners.length)
    }
  }

  /**
   * æ·»åŠ æ¶ˆæ¯åˆ°æœ«å°¾
   */
  addMessage(message: ChatMessage): void {
    this.dataArray.push(message)
    const index = this.dataArray.length - 1
    hilog.debug(DOMAIN, TAG, 'â• æ·»åŠ æ¶ˆæ¯ (ç´¢å¼•: %{public}d, ID: %{public}s)', index, message.id)
    this.notifyDataAdd(index)
  }

  /**
   * æ‰¹é‡æ·»åŠ æ¶ˆæ¯
   */
  addMessages(messages: ChatMessage[]): void {
    if (messages.length === 0) {
      return
    }
    const startIndex = this.dataArray.length
    for (let i = 0; i < messages.length; i++) {
      this.dataArray.push(messages[i])
    }
    hilog.debug(DOMAIN, TAG, 'â• æ‰¹é‡æ·»åŠ æ¶ˆæ¯ (èµ·å§‹ç´¢å¼•: %{public}d, æ•°é‡: %{public}d)', startIndex, messages.length)
    // é€šçŸ¥æ‰€æœ‰æ–°æ·»åŠ çš„æ¶ˆæ¯
    for (let i = 0; i < messages.length; i++) {
      this.notifyDataAdd(startIndex + i)
    }
  }

  /**
   * æ›´æ–°æŒ‡å®šç´¢å¼•çš„æ¶ˆæ¯
   */
  updateMessage(index: number, message: ChatMessage): void {
    if (index >= 0 && index < this.dataArray.length) {
      this.dataArray[index] = message
      hilog.debug(DOMAIN, TAG, 'ğŸ”„ æ›´æ–°æ¶ˆæ¯ (ç´¢å¼•: %{public}d, ID: %{public}s)', index, message.id)
      this.notifyDataChange(index)
    }
  }

  /**
   * æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆä¼˜åŒ–æµå¼è¾“å‡ºåœºæ™¯ï¼‰
   */
  updateLastMessage(message: ChatMessage): void {
    if (this.dataArray.length > 0) {
      const index = this.dataArray.length - 1
      this.dataArray[index] = message
      hilog.debug(DOMAIN, TAG, 'ğŸ”„ æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯ (ç´¢å¼•: %{public}d, ID: %{public}s)', index, message.id)
      this.notifyDataChange(index)
    }
  }

  /**
   * å¼ºåˆ¶é€šçŸ¥æœ€åä¸€æ¡æ¶ˆæ¯å·²å˜åŒ–ï¼ˆç”¨äºåœæ­¢ç”Ÿæˆç­‰åœºæ™¯ï¼‰
   * å½“æ¶ˆæ¯å¯¹è±¡å±æ€§å˜åŒ–ä½†å¼•ç”¨æœªå˜æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•å¼ºåˆ¶è§¦å‘ UI æ›´æ–°
   */
  notifyLastMessageChanged(): void {
    if (this.dataArray.length > 0) {
      const index = this.dataArray.length - 1
      hilog.info(DOMAIN, TAG, 'ğŸ”” å¼ºåˆ¶é€šçŸ¥æœ€åä¸€æ¡æ¶ˆæ¯å˜åŒ– (ç´¢å¼•: %{public}d)', index)
      this.notifyDataChange(index)
    }
  }

  /**
   * åˆ é™¤æŒ‡å®šç´¢å¼•çš„æ¶ˆæ¯
   */
  removeMessage(index: number): void {
    if (index >= 0 && index < this.dataArray.length) {
      const messageId = this.dataArray[index].id
      this.dataArray.splice(index, 1)
      hilog.debug(DOMAIN, TAG, 'ğŸ—‘ï¸ åˆ é™¤æ¶ˆæ¯ (ç´¢å¼•: %{public}d, ID: %{public}s)', index, messageId)
      this.notifyDataDelete(index)
    }
  }

  /**
   * æ ¹æ® ID æŸ¥æ‰¾æ¶ˆæ¯ç´¢å¼•
   */
  findMessageIndex(messageId: string): number {
    for (let i = 0; i < this.dataArray.length; i++) {
      if (this.dataArray[i].id === messageId) {
        return i
      }
    }
    return -1
  }

  /**
   * æ ¹æ® ID åˆ é™¤æ¶ˆæ¯
   */
  removeMessageById(messageId: string): boolean {
    const index = this.findMessageIndex(messageId)
    if (index >= 0) {
      this.removeMessage(index)
      return true
    }
    return false
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
   */
  clear(): void {
    const count = this.dataArray.length
    this.dataArray = []
    hilog.info(DOMAIN, TAG, 'ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯ (æ¸…é™¤ %{public}d æ¡)', count)
    this.notifyDataReload()
  }

  /**
   * é‡è½½æ•°æ®ï¼ˆé€šçŸ¥ LazyForEach é‡æ–°æ¸²æŸ“æ‰€æœ‰å­ç»„ä»¶ï¼‰
   */
  reload(): void {
    hilog.debug(DOMAIN, TAG, 'ğŸ”„ é‡è½½æ•°æ®')
    this.notifyDataReload()
  }

  // ========== IDataSource é€šçŸ¥æ–¹æ³• ==========

  /**
   * é€šçŸ¥æ•°æ®é‡è½½
   */
  private notifyDataReload(): void {
    this.listeners.forEach((listener: DataChangeListener) => {
      listener.onDataReloaded()
    })
  }

  /**
   * é€šçŸ¥æ•°æ®æ·»åŠ 
   */
  private notifyDataAdd(index: number): void {
    this.listeners.forEach((listener: DataChangeListener) => {
      listener.onDataAdd(index)
    })
  }

  /**
   * é€šçŸ¥æ•°æ®å˜åŒ–
   */
  private notifyDataChange(index: number): void {
    this.listeners.forEach((listener: DataChangeListener) => {
      listener.onDataChange(index)
    })
  }

  /**
   * é€šçŸ¥æ•°æ®åˆ é™¤
   */
  private notifyDataDelete(index: number): void {
    this.listeners.forEach((listener: DataChangeListener) => {
      listener.onDataDelete(index)
    })
  }

  /**
   * é€šçŸ¥æ•°æ®ç§»åŠ¨
   */
  private notifyDataMove(from: number, to: number): void {
    this.listeners.forEach((listener: DataChangeListener) => {
      listener.onDataMove(from, to)
    })
  }

  /**
   * è·å–æ•°æ®æºç»Ÿè®¡ä¿¡æ¯
   */
  getStats(): DataSourceStats {
    const stats: DataSourceStats = {
      totalCount: this.dataArray.length,
      listenerCount: this.listeners.length
    }
    return stats
  }
}

/**
 * åˆ›å»ºæ¶ˆæ¯æ•°æ®æº
 */
export function createMessageDataSource(messages: ChatMessage[] = []): MessageDataSource {
  return new MessageDataSource(messages)
}
