/**
 * åˆ†äº«æœåŠ¡
 * æä¾›æ¶ˆæ¯åˆ†äº«åŠŸèƒ½ï¼šå›¾ç‰‡åˆ†äº«ã€Markdownåˆ†äº«ã€çº¯æ–‡æœ¬åˆ†äº«
 */
import { systemShare } from '@kit.ShareKit'
import { uniformTypeDescriptor as utd } from '@kit.ArkData'
import { fileUri } from '@kit.CoreFileKit'
import { image } from '@kit.ImageKit'
import { fileIo as fs } from '@kit.CoreFileKit'
import { common } from '@kit.AbilityKit'
import { ChatMessage, MessageRole } from '../models/ChatModels'

// åˆ†äº«æ¨¡å¼æšä¸¾
export enum ShareMode {
  IMAGE = 'image',      // å›¾ç‰‡åˆ†äº«ï¼ˆå¡ç‰‡é£æ ¼ï¼‰
  MARKDOWN = 'markdown', // Markdown æ ¼å¼
  TEXT = 'text'         // çº¯æ–‡æœ¬æ ¼å¼
}

// åˆ†äº«ç»“æœ
export interface ShareResult {
  success: boolean
  errorMessage: string
}

export class ShareService {
  private context: common.UIAbilityContext | null = null

  // åˆå§‹åŒ–æœåŠ¡
  init(context: common.UIAbilityContext): void {
    this.context = context
  }

  // å°†æ¶ˆæ¯åˆ—è¡¨è½¬æ¢ä¸º Markdown æ ¼å¼
  convertToMarkdown(messages: ChatMessage[]): string {
    const lines: string[] = []
    lines.push('# å¯¹è¯è®°å½•\n')
    lines.push(`> å¯¼å‡ºæ—¶é—´: ${this.formatDateTime(Date.now())}\n`)
    lines.push('---\n')

    for (let i = 0; i < messages.length; i++) {
      const msg = messages[i]
      const roleLabel = msg.role === MessageRole.USER ? 'ğŸ‘¤ **ç”¨æˆ·**' : 'ğŸ¤– **AI**'
      const time = this.formatTime(msg.timestamp)

      lines.push(`### ${roleLabel} Â· ${time}\n`)

      // æ·»åŠ æ¶ˆæ¯å†…å®¹
      if (msg.content.length > 0) {
        lines.push(msg.content)
        lines.push('')
      }

      // å¦‚æœæœ‰æ¨ç†å†…å®¹ï¼Œæ·»åŠ æŠ˜å å—
      if (msg.reasoningContent.length > 0) {
        lines.push('<details>')
        lines.push('<summary>ğŸ’­ æ€è€ƒè¿‡ç¨‹</summary>\n')
        lines.push(msg.reasoningContent)
        lines.push('</details>\n')
      }

      lines.push('---\n')
    }

    return lines.join('\n')
  }

  // å°†æ¶ˆæ¯åˆ—è¡¨è½¬æ¢ä¸ºçº¯æ–‡æœ¬æ ¼å¼
  convertToPlainText(messages: ChatMessage[]): string {
    const lines: string[] = []
    lines.push('=== å¯¹è¯è®°å½• ===')
    lines.push(`å¯¼å‡ºæ—¶é—´: ${this.formatDateTime(Date.now())}`)
    lines.push('')

    for (let i = 0; i < messages.length; i++) {
      const msg = messages[i]
      const roleLabel = msg.role === MessageRole.USER ? '[ç”¨æˆ·]' : '[AI]'
      const time = this.formatTime(msg.timestamp)

      lines.push(`${roleLabel} ${time}`)
      lines.push(msg.content)

      // å¦‚æœæœ‰æ¨ç†å†…å®¹
      if (msg.reasoningContent.length > 0) {
        lines.push('')
        lines.push('[æ€è€ƒè¿‡ç¨‹]')
        lines.push(msg.reasoningContent)
      }

      lines.push('')
      lines.push('---')
      lines.push('')
    }

    return lines.join('\n')
  }

  // åˆ†äº«æ–‡æœ¬å†…å®¹
  async shareText(content: string, title: string = 'åˆ†äº«å¯¹è¯'): Promise<ShareResult> {
    if (this.context === null) {
      console.error('ShareService', '[shareText] æœåŠ¡æœªåˆå§‹åŒ–')
      return { success: false, errorMessage: 'æœåŠ¡æœªåˆå§‹åŒ–' }
    }

    try {
      console.info('ShareService', `[shareText] å¼€å§‹åˆ†äº«æ–‡æœ¬ï¼Œå†…å®¹é•¿åº¦: ${content.length}`)
      const shareData = new systemShare.SharedData({
        utd: utd.UniformDataType.PLAIN_TEXT,
        content: content,
        title: title
      })

      const controller = new systemShare.ShareController(shareData)
      console.info('ShareService', '[shareText] æ‰“å¼€åˆ†äº«é¢æ¿')
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DETAIL
      })

      console.info('ShareService', '[shareText] åˆ†äº«é¢æ¿å·²å…³é—­')
      return { success: true, errorMessage: '' }
    } catch (error) {
      console.error('ShareService', `[shareText] åˆ†äº«æ–‡æœ¬å¤±è´¥: ${JSON.stringify(error)}`)
      return { success: false, errorMessage: `åˆ†äº«å¤±è´¥: ${error}` }
    }
  }

  // åˆ†äº«å›¾ç‰‡
  async shareImage(imagePath: string, title: string = 'åˆ†äº«å¯¹è¯'): Promise<ShareResult> {
    if (this.context === null) {
      console.error('ShareService', '[shareImage] æœåŠ¡æœªåˆå§‹åŒ–')
      return { success: false, errorMessage: 'æœåŠ¡æœªåˆå§‹åŒ–' }
    }

    try {
      console.info('ShareService', `[shareImage] å¼€å§‹åˆ†äº«å›¾ç‰‡: ${imagePath}`)
      const uri = fileUri.getUriFromPath(imagePath)
      console.info('ShareService', `[shareImage] æ–‡ä»¶URI: ${uri}`)

      const shareData = new systemShare.SharedData({
        utd: utd.UniformDataType.PNG,
        uri: uri,
        title: title
      })

      const controller = new systemShare.ShareController(shareData)
      console.info('ShareService', '[shareImage] æ‰“å¼€åˆ†äº«é¢æ¿')
      await controller.show(this.context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DETAIL
      })

      console.info('ShareService', '[shareImage] åˆ†äº«é¢æ¿å·²å…³é—­')
      return { success: true, errorMessage: '' }
    } catch (error) {
      console.error('ShareService', `[shareImage] åˆ†äº«å›¾ç‰‡å¤±è´¥: ${JSON.stringify(error)}`)
      return { success: false, errorMessage: `åˆ†äº«å¤±è´¥: ${error}` }
    }
  }

  // æˆªå–ç»„ä»¶ä¸ºå›¾ç‰‡å¹¶ä¿å­˜
  async captureComponentAsImage(componentId: string, uiContext: UIContext): Promise<string> {
    try {
      // ä½¿ç”¨ componentSnapshot æˆªå–ç»„ä»¶
      const snapshot = uiContext.getComponentSnapshot()
      const pixelMap = await snapshot.get(componentId, { scale: 2 })

      // åˆ›å»ºå›¾ç‰‡æ‰“åŒ…å™¨
      const packer = image.createImagePacker()

      // æ‰“åŒ…ä¸º PNG
      const packOpts: image.PackingOption = {
        format: 'image/png',
        quality: 100
      }
      const arrayBuffer = await packer.packToData(pixelMap, packOpts)

      // ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•
      const fileName = `share_${Date.now()}.png`
      const tempDir = this.context?.tempDir ?? ''
      const filePath = `${tempDir}/${fileName}`

      const file = fs.openSync(filePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY)
      fs.writeSync(file.fd, arrayBuffer)
      fs.closeSync(file)

      // é‡Šæ”¾èµ„æº
      packer.release()
      pixelMap.release()

      return filePath
    } catch (e) {
      const errorMsg = `æˆªå›¾å¤±è´¥: ${JSON.stringify(e)}`
      console.error('ShareService', errorMsg)
      throw new Error(errorMsg)
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp)
    const hours = date.getHours()
    const minutes = date.getMinutes().toString().padStart(2, '0')
    const period = hours >= 12 ? 'PM' : 'AM'
    const displayHours = hours % 12 || 12
    return `${displayHours}:${minutes} ${period}`
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  private formatDateTime(timestamp: number): string {
    const date = new Date(timestamp)
    const year = date.getFullYear()
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    const day = date.getDate().toString().padStart(2, '0')
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')
    return `${year}-${month}-${day} ${hours}:${minutes}`
  }
}

// å•ä¾‹å®ä¾‹
let shareServiceInstance: ShareService | null = null

export function getShareService(): ShareService {
  if (shareServiceInstance === null) {
    shareServiceInstance = new ShareService()
  }
  return shareServiceInstance
}
