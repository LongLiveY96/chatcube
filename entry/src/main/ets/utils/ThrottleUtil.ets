import { hilog } from '@kit.PerformanceAnalysisKit'

const DOMAIN = 0x0002
const TAG = 'ThrottleUtil'

/**
 * èŠ‚æµå·¥å…·ç±»
 * ç”¨äºŽå‡å°‘é«˜é¢‘äº‹ä»¶çš„è§¦å‘é¢‘çŽ‡ï¼Œå¦‚æµå¼è¾“å‡ºæ—¶çš„ UI æ›´æ–°
 */
export class ThrottleUtil {
  // ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´
  private lastExecuteTime: number = 0
  // å¾…æ‰§è¡Œçš„å†…å®¹ç¼“å­˜
  private pendingContent: string = ''
  // å®šæ—¶å™¨ ID
  private timerId: number = -1
  // èŠ‚æµé—´éš”ï¼ˆæ¯«ç§’ï¼‰
  private readonly interval: number
  // æ˜¯å¦å·²å¯ç”¨
  private enabled: boolean = true

  constructor(interval: number = 150) {
    this.interval = interval
    hilog.debug(DOMAIN, TAG, 'ðŸš€ ThrottleUtil åˆå§‹åŒ– (é—´éš”: %{public}dms)', interval)
  }

  /**
   * èŠ‚æµæ‰§è¡Œ
   * @param content æ–°å¢žçš„å†…å®¹
   * @param callback æ‰§è¡Œå›žè°ƒï¼Œå‚æ•°ä¸ºç´¯ç§¯çš„å†…å®¹
   */
  throttle(content: string, callback: (content: string) => void): void {
    if (!this.enabled) {
      // èŠ‚æµç¦ç”¨æ—¶ï¼Œç›´æŽ¥æ‰§è¡Œå›žè°ƒ
      callback(content)
      return
    }

    const now = Date.now()

    // ç´¯ç§¯å¾…æ‰§è¡Œå†…å®¹
    this.pendingContent += content

    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearTimeout(this.timerId)
      this.timerId = -1
    }

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç«‹å³æ‰§è¡Œ
    if (now - this.lastExecuteTime >= this.interval) {
      // ç«‹å³æ‰§è¡Œ
      this.execute(callback)
    } else {
      // è®¾ç½®å®šæ—¶å™¨å»¶è¿Ÿæ‰§è¡Œ
      const delay = this.interval - (now - this.lastExecuteTime)
      this.timerId = setTimeout(() => {
        this.execute(callback)
      }, delay)
    }
  }

  /**
   * æ‰§è¡Œå›žè°ƒå¹¶é‡ç½®çŠ¶æ€
   */
  private execute(callback: (content: string) => void): void {
    if (this.pendingContent === '') {
      return
    }

    const contentToExecute = this.pendingContent
    this.pendingContent = ''
    this.lastExecuteTime = Date.now()
    this.timerId = -1

    callback(contentToExecute)
  }

  /**
   * ç«‹å³åˆ·æ–°ï¼ˆå¼ºåˆ¶æ‰§è¡Œå¾…å¤„ç†å†…å®¹ï¼‰
   * ç”¨äºŽç¡®ä¿åœ¨æ“ä½œå®Œæˆæ—¶æ‰€æœ‰å†…å®¹éƒ½è¢«å¤„ç†
   */
  flush(callback: (content: string) => void): void {
    if (this.timerId !== -1) {
      clearTimeout(this.timerId)
      this.timerId = -1
    }

    if (this.pendingContent !== '') {
      this.execute(callback)
    }
  }

  /**
   * é‡ç½®èŠ‚æµå™¨çŠ¶æ€
   */
  reset(): void {
    if (this.timerId !== -1) {
      clearTimeout(this.timerId)
      this.timerId = -1
    }
    this.pendingContent = ''
    this.lastExecuteTime = 0
    hilog.debug(DOMAIN, TAG, 'ðŸ”„ èŠ‚æµå™¨å·²é‡ç½®')
  }

  /**
   * å¯ç”¨èŠ‚æµ
   */
  enable(): void {
    this.enabled = true
    hilog.debug(DOMAIN, TAG, 'âœ… èŠ‚æµå·²å¯ç”¨')
  }

  /**
   * ç¦ç”¨èŠ‚æµ
   */
  disable(): void {
    this.enabled = false
    hilog.debug(DOMAIN, TAG, 'â›” èŠ‚æµå·²ç¦ç”¨')
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„å†…å®¹
   */
  hasPending(): boolean {
    return this.pendingContent !== '' || this.timerId !== -1
  }
}

/**
 * åˆ›å»ºèŠ‚æµå·¥å…·å®žä¾‹
 * @param interval èŠ‚æµé—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 150ms
 * @returns ThrottleUtil å®žä¾‹
 */
export function createThrottle(interval: number = 150): ThrottleUtil {
  return new ThrottleUtil(interval)
}

/**
 * æ»šåŠ¨èŠ‚æµå™¨ï¼ˆä¸“é—¨ç”¨äºŽæ»šåŠ¨æ“ä½œï¼‰
 * æ»šåŠ¨æ“ä½œå¯ä»¥ä½¿ç”¨æ›´é•¿çš„èŠ‚æµé—´éš”
 */
export class ScrollThrottle {
  private lastExecuteTime: number = 0
  private readonly interval: number
  private timerId: number = -1
  private enabled: boolean = true

  constructor(interval: number = 100) {
    this.interval = interval
  }

  throttle(callback: () => void): void {
    if (!this.enabled) {
      callback()
      return
    }

    const now = Date.now()

    if (this.timerId !== -1) {
      clearTimeout(this.timerId)
      this.timerId = -1
    }

    if (now - this.lastExecuteTime >= this.interval) {
      this.lastExecuteTime = now
      callback()
    } else {
      const delay = this.interval - (now - this.lastExecuteTime)
      this.timerId = setTimeout(() => {
        this.lastExecuteTime = Date.now()
        callback()
      }, delay)
    }
  }

  reset(): void {
    if (this.timerId !== -1) {
      clearTimeout(this.timerId)
      this.timerId = -1
    }
    this.lastExecuteTime = 0
  }
}

